var c=document.getElementsByTagName("canvas")[0],
    t=c.getContext("2d"),
    M=Math,
    Q=document;

var l=0,
    s=0,
    e=0;

var P=["rgba(0,0,0,0)","#630","#95F","#FA8","#20C","#495","#362","#820","#333"];

var O=[];

O.push({n:'p',x:250,y:250,dx:0,dy:0,z:4,w:4,h:4,f:0,a:0.15,s:3,b:0,t:[[0,0,0,0,2,1,1,2,2,1,1,2,0,0,0,0],[0,4,0,3,2,1,1,2,2,1,1,2,3,0,4,0],[0,0,0,0,2,1,1,2,2,1,1,2,0,0,0,0],[3,0,4,0,2,1,1,2,2,1,1,2,0,4,0,3]]});

Q.onkeydown=function(e) {
	var k = e.keyCode;
    if (k==81) O[0].dx=-1;
    if (k==68) O[0].dx=1;
    if (k==90) O[0].dy=-1;
    if (k==83) O[0].dy=1;
};

Q.onkeyup=function(e) {
    var k = e.keyCode;
    if (k==81||k==68) O[0].dx=0;
    if (k==90||k==83) O[0].dy=0;
};

function G() {
    l++;
    for (o=0;o<l+3;o++) {
        O.push({n:'e',x:M.floor(M.random()*500),y:M.floor(M.random()*500),dx:0,dy:0,z:5+M.random()*l,w:4,h:4,b:M.random()*80,f:M.random()*3,a:0.3,s:1.1,t:[[7,6,5,7,0,5,6,0,7,6,5,7,0,8,8,0],[7,6,5,0,0,5,6,7,0,6,5,7,7,8,8,0],[0,6,5,0,7,5,6,7,0,6,5,0,7,8,8,7],[0,6,5,7,7,5,6,0,7,6,5,0,0,8,8,7]]});
        e++;
    }
}

function B(o,x,y,nx,ny,s,z){
    var bx=nx-x;
    var by=ny-y;
    if (M.abs(bx)<M.abs(by)) {
        bx=bx/M.abs(by);
        by=by/M.abs(by);
    } else {
        by=by/M.abs(bx);
        bx=bx/M.abs(bx);
    }
    O.push({n:'b',x:x,y:y,dx:bx,dy:by,z:z,w:1,h:1,f:0,a:1,s:s,o:o,t:[[3],[7],[0]]});
}

function C(o,t){
    return !(t.x>=o.x+o.z||t.x+t.z<=o.x||t.y>=o.y+o.z||t.y+t.z<=o.y);
}

function D(o) {
    O.splice(O.indexOf(o),1);
}

c.addEventListener('click', function(e) {
    var p=O[0];
    if (p.b<=0) {
        var rect = c.getBoundingClientRect();
        B('p',p.x,p.y,e.clientX-rect.left,e.clientY-rect.top,6,4);
        p.b=20;
    }
}, false);

G();
var I=setInterval(function () {
    c.width = c.width;
    t.fillText('lvl'+l+' pts:'+s, 5, 15);

    O.forEach(function(ob){
        ob.b-=1;
        switch(ob.n) {
            case 'e':
                ob.dx=ob.x<O[0].x?1:-1;
                ob.dy=ob.y<O[0].y?1:-1;
                if (ob.b<=0){
                    B('e',ob.x,ob.y,O[0].x,O[0].y,ob.s*4,ob.z);
                    ob.b=80-2*ob.z;
                }
                break;
            case 'b':
                if (ob.x<0||ob.x>500||ob.y<0||ob.y>500) {
                    D(ob);
                } else {
                    O.every(function(tg){
                        if (tg.n=='e'&&ob.o=='p'&&C(ob,tg)) {
                            D(tg);
                            D(ob);
                            s++;
                            if (--e<=0) G();
                            return false;
                        } else if (tg.n=='p'&&ob.o=='e'&&C(ob,tg)) {
                            clearInterval(I);
                        }
                        return true;
                    });
                }
        }

        ob.x+=ob.s*ob.dx;
        ob.y+=ob.s*ob.dy;

        ow=ob.w;
        oh=ob.h;
        z=ob.z;
        fm=M.floor(ob.f);
        if(ob.dx!==0||ob.dy!==0) M.floor(ob.f+ob.a)<=ob.t.length-1?ob.f+=ob.a:ob.f=0;

        for(i=0;i<ow*oh;i++) {
            t.fillStyle=P[ob.t[fm][i]];
            t.fillRect(ob.x+z*(i%ow),ob.y+z*(M.floor(i/oh)),z,z);
        }
    });

},33);