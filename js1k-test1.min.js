//misc
M=Math,
F=M.floor,
R=M.random,
A=M.abs,
Q=500;

//init level
//level,score,frame
l=s=f=0;

//add the player
//type,x,y,dx,dy,zoom,speed,timebeforefire,tiles,size
O=[['p',Q/2,Q/2,0,0,4,3,0,'04403334411001000440433301140010',4]];

//keys
b.onkeydown=function(e) {
    //LEFT=37 UP=38 RIGHT=39 DOWN=40
	k=e.keyCode;
    k==37||k==39?O[0][3]=k-38:0;
    k==38||k==40?O[0][4]=k-39:0;
};

b.onkeyup=function(e) {
    //LEFT=37 UP=38 RIGHT=39 DOWN=40
    k=e.keyCode;
    k==37||k==39?O[0][3]=0:0;
    k==38||k==40?O[0][4]=0:0;
};

//new game
function G() {
    l++;
    //add the ennemies
    for (o=0;o<l;o++) {
        //type,x,y,dx,dy,zoom,speed,timebeforefire,tiles,size
        O.push(['e',R()*Q,R()*Q,0,0,5+R()*l,1.1,R()*80,'10210111111010101021011311101010',4]);
    }
}

//fires a bullet (origintype,originx,originy,targetx,targety,speed,zoom)
function B(o,x,y,X,Y,s,z){
    V=X-x;
    W=Y-y;
    if (A(V)<A(W)) {
        V=V/A(W);
        W=W/A(W);
    } else {
        W=W/A(V);
        V=V/A(V);
    }
    //create the bullet
    //type,x,y,dx,dy,zoom,speed,N#A,tiles,size,origin
    O.push(['b',x,y,V,W,z,s,0,'43',1,o]);
}

//collision
function C(o,t){
    X=o[1],Y=o[2],Z=o[5],
    U=t[1],V=t[2],W=t[5];
    return !(U>=X+Z||U+W<=X||V>=Y+Z||V+W<=Y);
}

//destroy an object
function D(o) {
    O.splice(O.indexOf(o),1);
}

//player fire a bullet
a.addEventListener('click', function(e) {
    p=O[0];
    if (p[7]<0) {
        B('p',p[1],p[2],e.x,e.y,6,4);
        p[7]=20;
    }
}, 0);

//cycle
G();
I=setInterval(function () {
    //clear the scene
    a.width+=0;

    //show level & score
    c.fillText('lv'+l+' pt'+s, 5, 15);
    
    //manage objects
    O.forEach(function(o){
        /* reminder
        o[0] name
        o[1] x
        o[2] y
        o[3] dx
        o[4] dy
        o[5] zoom
        o[6] speed
        o[7] next time before firing again
        o[8] tiles
        o[9] size
        */
        
        //reduce the 'next time before firing again'
        o[7]--;
        
        //ennemy
        if (o[0]=='e') {
            o[3]=o[1]<O[0][1]?1:-1;
            o[4]=o[2]<O[0][2]?1:-1;
            if (o[7]<0){
                B('e',o[1],o[2],O[0][1],O[0][2],o[6]*4,o[5]);
                o[7]=30;
            }
        }
        
        //bullet
        if (o[0]=='b') {
            if (o[1]<0||o[1]>Q||o[2]<0||o[2]>Q) {
                //destroy the bullet if out of the arena
                D(o);
            } else {
                //check for bullet collision
                O.forEach(function(t){
                    if (t[0]=='e'&&o[10]=='p'&&C(o,t)) {
                        D(t);
                        D(o);
                        s++;
                    }
                    t[0]=='p'&&o[10]=='e'&&C(o,t)?clearInterval(I):0;
                });
            }
        }
        
        //move the object
        o[1]+=o[3]*o[6];
        o[2]+=o[4]*o[6];

        //draw the object
        for(i=0;i<o[9]*o[9];i++) {
            k=o[8].charAt(i+o[9]*o[9]*(f%20==0));
            c.fillStyle=["#FFF","#294","#000","#E21","#DAA"][k];
            c.fillRect(o[1]+o[5]*(i%o[9]),o[2]+o[5]*(F(i/o[9])),o[5],o[5]);
        }
        
        //next frame
        f++;
        
        //new game ?
        O.length<2?G():0;
    });
},33);